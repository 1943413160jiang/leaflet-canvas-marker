<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="/css/leaflet.css" />
    <link rel="stylesheet" href="/css/blinkmarker.css" />
    <link rel="stylesheet" href="/css/leaflet-geoman.css" />
    <script src="/js/rbush.min.js"></script>
    <script src="/js/leaflet.js"></script>

    <!-- 引入leaflet-canvas-marker插件,已解决了缩放时飘的问题 -->
    <!-- <script src="/js/leaflet.canvas-markers.js"></script> -->
    <script src="/js/leaflet.canvas-markers2.js"></script>
    <!-- 高亮 -->
    <script src="/js/blinkmarker.js"></script>
    <!-- 圈画 -->
    <script src="/js/leaflet-geoman.min.js"></script>
    <script src="/js/leaflet-freedraw.iife.js"></script>
    <script src="/js/turf.min.js"></script>
    <script src="/js/xe-utils.js"></script>
    <style>
      #map {
        width: 100%;
        height: 100vh;
      }

      /* .coordinate {
        position: absolute;
        bottom: 10px;
        right: 50%;
        z-index: 999;
      } */

      .map.mode-create {
        cursor: crosshair;
      }

      .leaflet-pm-toolbar .icon-freedraw {
        background: url("data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiA/PjwhRE9DVFlQRSBzdmcgIFBVQkxJQyAnLS8vVzNDLy9EVEQgU1ZHIDEuMS8vRU4nICAnaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkJz48c3ZnIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDEyOCAxMjgiIGhlaWdodD0iMTI4cHgiIGlkPSJMYXllcl8xIiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAxMjggMTI4IiB3aWR0aD0iMTI4cHgiIHhtbDpzcGFjZT0icHJlc2VydmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgeG1sbnM6eGxpbms9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsiPjxwYXRoIGQ9Ik0xMjMuMzE1LDE2TDExMi4wMDMsNC42ODZDMTA4Ljg3OCwxLjU2MywxMDQuNzgsMCwxMDAuNjg3LDBzLTguMTg4LDEuNTYzLTExLjMxMyw0LjY4NmwtNjguNjksNjguNjg5ICBDMTcuNTYzLDc2LjUsOC4wMDQsODguNTg2LDgsOTIuNjhMMCwxMjhsMzUuMzEzLThjMCwwLDE2LjE4OC05LjU2MywxOS4zMTMtMTIuNjg4bDY4LjY5LTY4LjY4NyAgQzEyOS41NjIsMzIuMzc1LDEyOS41NjIsMjIuMjQzLDEyMy4zMTUsMTZ6IE0xMC42MDUsMTE3LjM5OGw1LjE5NS0yMi45NTNjMC4wNzQtMC4zMjgsMC4xMjktMC42NjQsMC4xNi0wLjk5MiAgYzAuMDE2LTAuMDQ3LDAuMDU5LTAuMTE3LDAuMDc4LTAuMTY0bDE4LjA5LDE4LjA5NGMtMC42MDUsMC4zNjctMS4yMTUsMC43MzQtMS44MTMsMS4wOTRMMTAuNjA1LDExNy4zOTh6IE00OC45ODQsMTAxLjY0MSAgYy0wLjkwNiwwLjg1OS00LjAzOSwyLjk3Ny03Ljg2Nyw1LjQxNEwyMC4zOTEsODYuMzI4YzIuMTI1LTIuOTE0LDQuNDkyLTUuODQ0LDUuOTQ5LTcuMjk3bDUxLjcyMi01MS43MThsMjIuNjI1LDIyLjYyNSAgTDQ4Ljk4NCwxMDEuNjQxeiBNMTE3LjY1OSwzMi45NjlsLTExLjMxNiwxMS4zMTNMODMuNzE4LDIxLjY1N2wxMS4zMTYtMTEuMzEzQzk2LjU0Miw4LjgyOSw5OC41NSw4LDEwMC42ODcsOCAgczQuMTQ4LDAuODM2LDUuNjYsMi4zNDRsMTEuMzEzLDExLjMxM2MxLjUxMiwxLjUwOCwyLjM0LDMuNTE2LDIuMzQsNS42NTZDMTE5Ljk5OSwyOS40NDYsMTE5LjE2NywzMS40NjEsMTE3LjY1OSwzMi45Njl6IiBmaWxsPSIjNTQ2RTdBIi8+PC9zdmc+");
        background-size: 20px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <script>
      /**
       *1.实现拖拽站点移动
       *2.在站点下面显示站点名字
       *3.站点高亮
       *4.圈画
       */
      var map = L.map("map", {
        preferCanvas: true, //使用canvas模式渲染矢量图形
      }).setView([28.19, 112.98], 6);
      // const osm = L.tileLayer(
      //   "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      //   {
      //     attribution:
      //       '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      //   }
      // );
      // osm.addTo(map);

      // 初始化canvas layer
      var ciLayer = L.canvasIconLayer({}).addTo(map);

      // 圈画
      const freeDraw = new FreeDraw();
      map.addLayer(freeDraw);
      freeDraw.mode(FreeDraw.NONE);

      map.pm.addControls({
        position: "topleft",
        drawCircle: false,
      });

      map.pm.setGlobalOptions({
        limitMarkersToCount: 1,
      });

      class LayerCanvas {
        mapMarker = {};
        mapIcons = {};
        removeIconMarkers = [];
        isTouch = { isUp: false };
        timer = null;
        timer2 = null;
        freeDrawEnabled = false;

        constructor({ map, ciLayer, freeDraw }) {
          this.map = map;
          this.ciLayer = ciLayer;
          this.freeDraw = freeDraw;
        }
        //切换圈画
        toggleFreeDraw() {
          const flag = this.freeDrawEnabled;
          console.log(flag);
          if (flag) {
            freeDraw.mode(FreeDraw.NONE);
          } else {
            freeDraw.mode(FreeDraw.CREATE);
          }
          this.freeDrawEnabled = !flag;
        }
        // 判断一个点是否在多边形内
        isInPolygon(point, rect) {
          const poly = turf.polygon([rect]);
          return turf.booleanPointInPolygon(point, poly);
        }
        // 鼠标经过到点会触发
        mousemoveListener(e, ret) {
          const that = this;
          const { lat, lng } = e.latlng;
          const marker = ret[0].data;
          const { lat: la, lng: ln } = marker.getLatLng();

          // 判断地图上有没有这个marker并且经纬度要相同并且没有被鼠标按下
          if (
            !map.hasLayer(marker) &&
            Math.floor(lat) === Math.floor(la) &&
            Math.floor(lng) === Math.floor(ln) &&
            !that.isTouch.isUp
          ) {
            // 设置图标
            marker.setIcon(this.mapIcons["green"]);
            marker.addTo(this.map);
            // 方便删除
            that.removeIconMarkers.push(marker);

            // 绑定事件
            marker.on("mousedown", function () {
              // 设为true，防止拖拽触发mouseout
              that.isTouch.isUp = true;
              // 移除画布中的marker
              that.ciLayer.removeLayer(this);
            });
            marker.on("mouseup", function () {
              // 设置false 让鼠标离开时移除地图上icon
              that.isTouch.isUp = false;
              // 添加画布中的marker
              that.ciLayer.addLayer(this);
            });
            marker.on("mouseout", function () {
              if (that.isTouch.isUp) return;
              // 移除icon
              that.onRemoveIconMarker();
            });
          }
        }
        // 删除marker icon
        onRemoveIconMarker() {
          if (this.timer) {
            clearTimeout(this.timer);
            this.timer = null;
          }
          this.timer = setTimeout(() => {
            this.removeIconMarkers.forEach((marker) => marker.remove());
            this.removeIconMarkers = [];
          });
        }
        // 初始化事件
        initEvent() {
          this.ciLayer.addOnMousemoveListener(
            this.mousemoveListener.bind(this)
          );
          this.freeDraw.on("markers", (e) => {
            if (e.eventType === "create" && e.latLngs.length) {
              var polygon = L.polygon(e.latLngs).addTo(map);
              freeDraw.clear();
              const pt = turf.point([28.19, 112.98]);
              const latlngs = e.latLngs[0].map((item) => [item.lat, item.lng]);
              console.log(this.isInPolygon(pt, latlngs));
            }
          });
        }
        // 初始化draw
        initDraw() {
          this.map.pm.Toolbar.createCustomControl({
            name: "freeDraw",
            onClick: this.toggleFreeDraw,
            className: "icon-freedraw",
          });
        }
        // 初始化icon
        initIcons() {
          const icons = [
            { name: "blue", url: "/imgs/blue_point.png" },
            { name: "green", url: "/imgs/green_point.png" },
            { name: "yellow", url: "/imgs/yellow_point.png" },
            { name: "rainfall", url: "/imgs/rainfall.png" },
            { name: "reservoir", url: "/imgs/reservoir.png" },
            { name: "water", url: "/imgs/water_level.png" },
          ];
          const obj = {};

          for (let i = 0; i < icons.length; i++) {
            obj[icons[i].name] = L.icon({
              iconUrl: icons[i].url,
              iconSize: [14, 14],
              iconAnchor: [7, 7],
            });
          }
          this.mapIcons = obj;
        }
        // 初始化marker
        initMarker() {
          const that = this;
          const markers = [];
          const mapMarker = {};
          const icon = this.mapIcons["blue"];
          for (var i = 0; i < 2000; i++) {
            var lat = 28.19 + (Math.random() - Math.random()) * 10;
            var lng = 112.98 + (Math.random() - Math.random()) * 10;
            var id = i;

            var marker = L.marker([lat, lng], {
              icon: icon,
              draggable: true,
            });

            marker.customId = id;
            markers.push(marker);
            mapMarker[id] = { lat, lng, marker };
          }
          this.ciLayer.addLayers(markers);
          this.mapMarker = mapMarker;
        }
        init() {
          this.initIcons();
          this.initMarker();
          this.initDraw();
          this.initEvent();
        }
      }
      const l = new LayerCanvas({ map, ciLayer, freeDraw });
      l.init();

      // 站点高亮
      L.blinkMarker([28.19, 112.98], {
        iconSize: [14, 14],
        color: "red",
        speedTime: 1,
        iconUrl: "/imgs/water_level.png",
        draggable: true,
      }).addTo(map);

      // var freeDrawEnabled = false;

      // function toggleFreeDraw() {
      //   if (freeDrawEnabled) {
      //     freeDraw.mode(FreeDraw.NONE);
      //   } else {
      //     freeDraw.mode(FreeDraw.CREATE);
      //   }
      //   freeDrawEnabled = !freeDrawEnabled;
      // }

      // freeDraw.on("markers", (e) => {
      //   if (e.eventType === "create" && e.latLngs.length) {
      //     var polygon = L.polygon(e.latLngs).addTo(map);
      //     freeDraw.clear();
      //     const pt = turf.point([28.19, 112.98]);
      //     const latlngs = e.latLngs[0].map((item) => [item.lat, item.lng]);
      //     // console.log(isInPolygon(pt, latlngs));
      //   }
      // });

      // function isInPolygon(point, rect) {
      //   const poly = turf.polygon([rect]);
      //   return turf.booleanPointInPolygon(point, poly);
      // }
    </script>
  </body>
</html>
